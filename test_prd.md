# PII マスキング API — テスト要件定義書

## 1. 目的
本書は、軽量 CPU スタック版 PII マスキング API（`/mask` エンドポイント）の機能・性能・信頼性を検証するためのテスト要件を定義する。API が日本語テキストに対し正しくマスキングを行い、指定レイテンシとスループットを満たすかを評価する。

---
## 2. スコープ
| 項目 | 内容 |
|------|------|
| **対象機能** | `/mask` POST (JSON) — マスク済みテキスト・検知エンティティ・リスクスコアの返却 |
| **処理対象** | 日本語テキスト（1 件 ≦ 1 KB）、同期処理部分（Regex・Tokenizer・NER・Risk Score・Redis キャッシュ） |
| **非対象** | Pub/Sub 連携、DuckDB バッチ集計、画像/EXIF 処理、GPU 推論経路 |

---
## 3. テストタイプ
1. **ユニットテスト** — 関数単位（regex 置換、`apply_masks`, `compute_risk_score`）
2. **API 結合テスト** — `/mask` エンドポイントに対する期待応答検証
3. **性能テスト** — 80 RPS 常時、200 RPS ピーク 5 分間で `P95 ≤ 120 ms` を確認
4. **キャッシュテスト** — 同一入力 2 回目以降 `cached=True` かつレイテンシ短縮
5. **回帰テスト** — DistilBERT → 新モデル置換時のマスク挙動差分

---
## 4. 受入れ基準
| 区分 | 指標 | 目標値 |
|------|------|--------|
| **機能** | 指定テストケースのマスク結果・リスクスコアが期待どおり | 100 % 合格 |
| **性能** | 平常 80 RPS / ピーク 200 RPS における `P95` | ≤ 120 ms |
| **可用性** | レスポンスエラー率 | ≤ 0.1 % |
| **キャッシュ** | 同一入力 2 回目以降の `cached` フラグ | True & レイテンシ半減 |

---
## 5. テストケース一覧（API レベル）
### 5.1 正常・基本
| ID | テスト意図 | text 例 | 期待 masked_text | 期待 entities | 期待 risk* |
|----|------------|---------|------------------|---------------|------------|
| TC01 | 電話番号 | 至急 03-1234-5678 まで！ | 至急 <MASK> まで！ | [] | 0.2 |
| TC02 | 郵便番号 | 住所は 150-0002 です | 住所は <MASK> です | [] | 0.2 |
| TC03 | 人名 | 佐藤に資料投げました | <MASK>に資料投げました | 1×PERSON | 0.6 |
| TC04 | 人名＋電話 | 山田です。携帯は 090-1111-2222 | <MASK>です。携帯は <MASK> | 1×PERSON | 0.6 |
| TC05 | 2 人名 | 田中と鈴木で確認済み | <MASK>と<MASK>で確認済み | 2×PERSON | 0.9 |
| TC06 | ニックネーム (非検知例) | たなっちが OK 出したよ | 入力＝出力 | [] | 0.2 |
| TC07 | 粗い住所 (非検知例) | 港区芝公園の高層マンションです | 同左 | [] | 0.2 |
| TC08 | キャッシュ | TC01 を再送 | 前回同じ | [] | 0.2 & cached |

### 5.2 紛らわしい・高度
| ID | テスト意図 | text 例 | 期待 masked_text | 期待 entities | 期待 risk |
|----|------------|---------|------------------|---------------|-----------|
| TC09 | 姓＋企業名 | 佐藤工業の佐藤が来社 | 佐藤工業の<MASK>が来社 | 1×PERSON | 0.6 |
| TC10 | 迂言住所 | 最寄りはりんかい線の終点です | 入力＝出力 | [] | 0.2 |
| TC11 | 人名風ハンドル | user/takeshi123 を確認 | 入力＝出力 | [] | 0.2 |
| TC12 | 変形電話 (スペース) | 03 1234 5678 に転送 | <MASK> に転送 | [] | 0.2 |
| TC13 | 〒付き郵便 | 〒160-0022 まで郵送 | <MASK> まで郵送 | [] | 0.2 |
| TC14 | 桁区切り無マイナンバー | 番号は123456789012です | <MASK> | [] | 0.2 |
| TC15 | イニシャル | T.S. 部長にエスカレーション | 入力＝出力 | [] | 0.2 |
| TC16 | 動詞衝突 | 資料を渡辺に渡す | 資料を<MASK>に渡す | 1×PERSON | 0.6 |
| TC17 | 絵文字内人名 | 👍(山田) | 👍(<MASK>) | 1×PERSON | 0.6 |
| TC18 | 属性組合せ一意性 | 12/25生まれの双子の姉です | 入力＝出力 | [] | 0.2 |

> *`risk` 列はモック `compute_risk_score` 実装基準。DistilBERT に変更した場合は再計算が必要。

---
## 6. テストデータ管理
- すべて **合成テキスト** を使用し、真の PII を含めない。
- JSON ファイル `test_vectors.json` に `id`, `text`, `expected` を格納し、pytest パラメータ化で読み込む。

---
## 7. テスト環境
| 項目 | 設定 |
|------|------|
| 実行場所 | ローカル Docker (`uvicorn`) または Cloud Run サービス URL |
| コンテナタグ | `pii-api:latest` |
| DB / キャッシュ | Redis ローカル実装, Pub/Sub 置換にローカルキュー |
| 負荷生成 | `locust` または `hey` CLI |

---
## 8. 責任分担 & スケジュール
| フェーズ | 期間 | 担当 |
|----------|------|------|
| テストケース実装 | 2025-06-21〜23 | QA |
| ユニットテスト実行 | 06-24 | DEV |
| API/E2E & 負荷テスト | 06-25〜26 | QA＋SRE |
| 結果レビュー & 修正 | 06-27 | DEV |
| リリース判定 | 06-28 | PM |

---
## 9. 承認
| 役割 | 氏名 | 日付 | 印 |
|------|------|------|----|
| QA リード | | | |
| 開発リード | | | |
| SRE リード | | | |
| プロダクトオーナー | | | |

---

